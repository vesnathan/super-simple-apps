AWSTemplateFormatVersion: "2010-09-09"
Description: "Simple Flashcards DynamoDB Table - Single Table Design"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage (e.g., dev, prod)
    AllowedPattern: ^[a-zA-Z0-9-]+$
  AppName:
    Type: String
    Description: Application name
    Default: flashcards
  DeployUserArn:
    Type: String
    Description: ARN of the IAM user that can assume the seed role
    Default: ""

Conditions:
  HasDeployUser: !Not [!Equals [!Ref DeployUserArn, ""]]

Resources:
  # Single-table design for flashcards application
  # Access Patterns:
  # 1. Get Deck by ID: PK=DECK#{deckId}, SK=DECK#{deckId}
  # 2. Get User's Decks: GSI1PK=USER#{userId}, GSI1SK begins_with DECK#
  # 3. Get Public Decks: GSI2PK=PUBLIC, GSI2SK={createdAt}#{deckId}
  DataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AppName}-${Stage}-data"
      AttributeDefinitions:
        - AttributeName: "PK"
          AttributeType: "S"
        - AttributeName: "SK"
          AttributeType: "S"
        - AttributeName: "GSI1PK"
          AttributeType: "S"
        - AttributeName: "GSI1SK"
          AttributeType: "S"
        - AttributeName: "GSI2PK"
          AttributeType: "S"
        - AttributeName: "GSI2SK"
          AttributeType: "S"
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: "PK"
          KeyType: "HASH"
        - AttributeName: "SK"
          KeyType: "RANGE"
      GlobalSecondaryIndexes:
        # GSI1: Query by user - get user's decks
        - IndexName: "GSI1"
          KeySchema:
            - AttributeName: "GSI1PK"
              KeyType: "HASH"
            - AttributeName: "GSI1SK"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
        # GSI2: Query public decks
        - IndexName: "GSI2"
          KeySchema:
            - AttributeName: "GSI2PK"
              KeyType: "HASH"
            - AttributeName: "GSI2SK"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      # Enable DynamoDB Streams for SEO static page generation
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: "Name"
          Value: !Sub "${AppName}-${Stage}-data"
        - Key: Project
          Value: super-simple-apps

  # Seed role - allows ssa-deploy to seed the database
  SeedRole:
    Type: AWS::IAM::Role
    Condition: HasDeployUser
    Properties:
      RoleName: !Sub "ssa-${AppName}-seed-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Ref DeployUserArn
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Sub "${AppName}-seed-${Stage}"
      Policies:
        - PolicyName: seed-policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: DynamoDBSeedAccess
                Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:PutItem
                  - dynamodb:DeleteItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt DataTable.Arn
                  - !Sub "${DataTable.Arn}/index/*"
      Tags:
        - Key: App
          Value: !Ref AppName
        - Key: Project
          Value: super-simple-apps
        - Key: Stage
          Value: !Ref Stage
        - Key: ManagedBy
          Value: cloudformation

Outputs:
  DataTableName:
    Description: "DynamoDB Data Table Name"
    Value: !Ref DataTable

  DataTableArn:
    Description: "DynamoDB Data Table ARN"
    Value: !GetAtt DataTable.Arn

  DataTableStreamArn:
    Description: "DynamoDB Data Table Stream ARN"
    Value: !GetAtt DataTable.StreamArn

  SeedRoleArn:
    Description: "ARN of the seed role for database seeding"
    Condition: HasDeployUser
    Value: !GetAtt SeedRole.Arn
