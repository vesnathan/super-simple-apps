AWSTemplateFormatVersion: "2010-09-09"
Description: "Simple Flashcards SEO Lambda Functions - DynamoDB Stream Handler"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage (e.g., dev, prod)
    AllowedPattern: ^[a-zA-Z0-9-]+$
  AppName:
    Type: String
    Description: Application name
    Default: simple-flashcards
  S3Bucket:
    Type: String
    Description: S3 bucket containing Lambda code
  S3Key:
    Type: String
    Description: S3 key for Lambda code zip
  DataTableName:
    Type: String
    Description: Name of the DynamoDB table
  DataTableArn:
    Type: String
    Description: ARN of the DynamoDB table
  DataTableStreamArn:
    Type: String
    Description: ARN of the DynamoDB table stream
  FrontendBucketName:
    Type: String
    Description: Name of the frontend S3 bucket
  FrontendBucketArn:
    Type: String
    Description: ARN of the frontend S3 bucket
  SiteUrl:
    Type: String
    Description: Public URL of the website

Resources:
  # Lambda Execution Role for SEO Generator
  SeoLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-seo-lambda-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBStreamAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetRecords
                  - dynamodb:GetShardIterator
                  - dynamodb:DescribeStream
                  - dynamodb:ListStreams
                Resource: !Ref DataTableStreamArn
        - PolicyName: S3WriteAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "${FrontendBucketArn}/deck/*"
      Tags:
        - Key: Project
          Value: !Ref AppName
        - Key: Stage
          Value: !Ref Stage

  # Generate Deck HTML Function
  GenerateDeckHtmlFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-generateDeckHtml-${Stage}"
      Runtime: nodejs18.x
      Handler: seo/generateDeckHtml.handler
      Role: !GetAtt SeoLambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref S3Bucket
        S3Key: !Ref S3Key
      Environment:
        Variables:
          FRONTEND_BUCKET: !Ref FrontendBucketName
          SITE_URL: !Ref SiteUrl
          STAGE: !Ref Stage
      Timeout: 60
      MemorySize: 256
      Tags:
        - Key: Project
          Value: !Ref AppName
        - Key: Stage
          Value: !Ref Stage

  # DynamoDB Stream Event Source Mapping
  DynamoDBStreamEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref DataTableStreamArn
      FunctionName: !Ref GenerateDeckHtmlFunction
      StartingPosition: LATEST
      BatchSize: 10
      MaximumBatchingWindowInSeconds: 5
      FilterCriteria:
        Filters:
          # Only process deck items (PK starts with DECK#)
          - Pattern: '{"dynamodb":{"NewImage":{"PK":{"S":[{"prefix":"DECK#"}]}}}}'

  # CloudWatch Log Group
  GenerateDeckHtmlLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub "/aws/lambda/${GenerateDeckHtmlFunction}"
      RetentionInDays: 14
      Tags:
        - Key: Project
          Value: !Ref AppName

Outputs:
  GenerateDeckHtmlFunctionArn:
    Description: ARN of GenerateDeckHtml function
    Value: !GetAtt GenerateDeckHtmlFunction.Arn

  SeoLambdaRoleArn:
    Description: ARN of the SEO Lambda execution role
    Value: !GetAtt SeoLambdaExecutionRole.Arn
